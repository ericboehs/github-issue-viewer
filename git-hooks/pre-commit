#!/bin/bash

# Pre-commit hook that runs EditorConfig, rubocop, and tests for Claude-authored commits
# Only runs when the commit author includes "claude" (case-insensitive)

# Get the commit author name
AUTHOR_NAME=$(git config user.name)

# Check if author name contains "claude" (case-insensitive)
if [[ ! "$AUTHOR_NAME" =~ [Cc][Ll][Aa][Uu][Dd][Ee] ]]; then
  exit 0
fi

echo "Claude-authored commit detected. Running pre-commit checks..."

# Check if editorconfig-checker is available
if command -v editorconfig-checker >/dev/null 2>&1; then
  # Run EditorConfig check
  echo "Running EditorConfig check..."
  if ! editorconfig-checker; then
    echo "‚ùå EditorConfig check failed. Please fix formatting issues and try again."
    echo "üí° Tip: Most editors can auto-fix these with EditorConfig plugin installed."
    exit 1
  fi
else
  echo "‚ö†Ô∏è  editorconfig-checker not found. Skipping EditorConfig check."
  echo "   Install with: npm install -g editorconfig-checker"
fi

# Run rubocop
echo "Running rubocop..."
if ! bin/rubocop; then
  echo "‚ùå Rubocop failed. Please fix the issues and try again."
  exit 1
fi

# Run tests
echo "Running tests..."
if ! bin/rails test; then
  echo "‚ùå Tests failed. Please fix the failing tests and try again."
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0